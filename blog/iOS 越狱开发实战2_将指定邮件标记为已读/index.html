<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="功能描述：Apple Mail iOS10.21.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。 MailAutoMarker定位Mail的可执行文件并class-dump它1➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Revers">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 越狱开发实战2—将指定邮件标记为已读">
<meta property="og:url" content="http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/index.html">
<meta property="og:site_name" content="iiooio">
<meta property="og:description" content="功能描述：Apple Mail iOS10.21.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。 MailAutoMarker定位Mail的可执行文件并class-dump它1➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Revers">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-04-18T14:56:06.218Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 越狱开发实战2—将指定邮件标记为已读">
<meta name="twitter:description" content="功能描述：Apple Mail iOS10.21.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。 MailAutoMarker定位Mail的可执行文件并class-dump它1➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Revers">
    
    
        
          
              <link rel="shortcut icon" href="/favicon.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/favicon.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
          
        
    
    <!-- title -->
    <title>iOS 越狱开发实战2—将指定邮件标记为已读</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/wedxz">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/blog/iOS 越狱开发实战1_Characount for Notes/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&text=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&is_video=false&description=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=iOS 越狱开发实战2—将指定邮件标记为已读&body=Check out this article: http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&name=iOS 越狱开发实战2—将指定邮件标记为已读&description=&lt;h4 id=&#34;功能描述：&#34;&gt;&lt;a href=&#34;#功能描述：&#34; class=&#34;headerlink&#34; title=&#34;功能描述：&#34;&gt;&lt;/a&gt;功能描述：&lt;/h4&gt;&lt;p&gt;Apple Mail iOS10.2&lt;br&gt;1.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。&lt;br&gt;2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。&lt;/p&gt;
&lt;h4 id=&#34;MailAutoMarker&#34;&gt;&lt;a href=&#34;#MailAutoMarker&#34; class=&#34;headerlink&#34; title=&#34;MailAutoMarker&#34;&gt;&lt;/a&gt;MailAutoMarker&lt;/h4&gt;&lt;h4 id=&#34;定位Mail的可执行文件并class-dump它&#34;&gt;&lt;a href=&#34;#定位Mail的可执行文件并class-dump它&#34; class=&#34;headerlink&#34; title=&#34;定位Mail的可执行文件并class-dump它&#34;&gt;&lt;/a&gt;定位Mail的可执行文件并class-dump它&lt;/h4&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMail.app -o /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMailHeader&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#功能描述："><span class="toc-number">1.</span> <span class="toc-text">功能描述：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MailAutoMarker"><span class="toc-number">2.</span> <span class="toc-text">MailAutoMarker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定位Mail的可执行文件并class-dump它"><span class="toc-number">3.</span> <span class="toc-text">定位Mail的可执行文件并class-dump它</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用Cycript找到Mailboxes界面的controller"><span class="toc-number">4.</span> <span class="toc-text">用Cycript找到Mailboxes界面的controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用Reveal和Cycript找到All-Inboxes界面的-delegate"><span class="toc-number">5.</span> <span class="toc-text">用Reveal和Cycript找到All Inboxes界面的 delegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MailboxContentViewController中定位“刷新完成”的响应函数"><span class="toc-number">6.</span> <span class="toc-text">MailboxContentViewController中定位“刷新完成”的响应函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MailboxContentSelectionModelDataSource-Protocol-h"><span class="toc-number">6.1.</span> <span class="toc-text">MailboxContentSelectionModelDataSource-Protocol.h</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MessageMiniMallObserver-Protocol-h"><span class="toc-number">6.2.</span> <span class="toc-text">MessageMiniMallObserver-Protocol.h</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从MessageMiniMall中拿到所有邮件"><span class="toc-number">7.</span> <span class="toc-text">从MessageMiniMall中拿到所有邮件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读"><span class="toc-number">8.</span> <span class="toc-text">从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写tweak"><span class="toc-number">9.</span> <span class="toc-text">编写tweak</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#用Theos新建tweak工程“AutoMailMarker”"><span class="toc-number">9.1.</span> <span class="toc-text">用Theos新建tweak工程“AutoMailMarker”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#构造AutoMailMarker-h"><span class="toc-number">9.2.</span> <span class="toc-text">构造AutoMailMarker.h</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编辑Tweak-xm"><span class="toc-number">9.3.</span> <span class="toc-text">编辑Tweak.xm</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编辑Makefile及control"><span class="toc-number">9.4.</span> <span class="toc-text">编辑Makefile及control</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装与测试"><span class="toc-number">10.</span> <span class="toc-text">安装与测试</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        iOS 越狱开发实战2—将指定邮件标记为已读
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">iiooio</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-03-25T09:30:39.000Z" itemprop="datePublished">2017-03-25</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/iOS/">iOS</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h4 id="功能描述："><a href="#功能描述：" class="headerlink" title="功能描述："></a>功能描述：</h4><p>Apple Mail iOS10.2<br>1.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。<br>2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。</p>
<h4 id="MailAutoMarker"><a href="#MailAutoMarker" class="headerlink" title="MailAutoMarker"></a>MailAutoMarker</h4><h4 id="定位Mail的可执行文件并class-dump它"><a href="#定位Mail的可执行文件并class-dump它" class="headerlink" title="定位Mail的可执行文件并class-dump它"></a>定位Mail的可执行文件并class-dump它</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMail.app -o /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMailHeader</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="用Cycript找到Mailboxes界面的controller"><a href="#用Cycript找到Mailboxes界面的controller" class="headerlink" title="用Cycript找到Mailboxes界面的controller"></a>用Cycript找到Mailboxes界面的controller</h4><p>方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WSCN-6SP:~ root# cycript -p MobileMail</span><br><span class="line">cy# [[[UIWindow keyWindow] rootViewController] _printHierarchy].toString()</span><br><span class="line">`&lt;MFApplicationSceneController 0x11c855400&gt;, state: appeared, view: &lt;UIView 0x11bd99ce0&gt;</span><br><span class="line">   | &lt;MailSplitViewController 0x11bd99980&gt;, state: appeared, view: &lt;UILayoutContainerView 0x11bd96e60&gt;</span><br><span class="line">   |    | &lt;UIMultiColumnViewController 0x11bd99200&gt;, state: appeared, view: &lt;UIView 0x11bdb3c90&gt;</span><br><span class="line">   |    |    | &lt;MailNavigationController 0x11c85c600&gt;, state: appeared, view: &lt;UILayoutContainerView 0x11bd51a40&gt;</span><br><span class="line">   |    |    |    | &lt;MailboxPickerController 0x11be36180&gt;, state: appeared, view: &lt;UITableView 0x11c063a00&gt;</span><br><span class="line">   |    |    | &lt;UINavigationController 0x11c8d9800&gt;, state: disappeared, view:  (view not loaded)</span><br><span class="line">   |    | &lt;MailDetailNavigationController 0x11c8b7a00&gt;, state: disappeared, view: &lt;UILayoutContainerView 0x11bd97060&gt; not in the window</span><br><span class="line">   |    |    | &lt;MFConversationViewController 0x11c802600&gt;, state: disappeared, view: &lt;UIView 0x11bd4f650&gt; not in the window`</span><br></pre></td></tr></table></figure>
<p>方法二：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cy# [[UIApp keyWindow] recursiveDescription].toString()</span><br><span class="line">`&lt;MFWindow: 0x11dd45a40; baseClass = UIWindow; frame = (0 0; 414 736); autoresize = W+H; tintColor = UIExtendedSRGBColorSpace 0 0.478431 1 1; gestureRecognizers = &lt;NSArray: 0x174242c40&gt;; layer = &lt;UIWindowLayer: 0x174039680&gt;&gt;</span><br><span class="line">   | &lt;UIView: 0x11dd76880; frame = (0 0; 414 736); opaque = NO; autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x17025bd20&gt;; layer = &lt;CALayer: 0x17403e760&gt;&gt;</span><br><span class="line">   |    | &lt;UIView: 0x11dd4c340; frame = (0 0; 414 736); layer = &lt;CALayer: 0x17403d7c0&gt;&gt;</span><br><span class="line">   |    |    | &lt;_MFActorItemView: 0x11dd7b100; frame = (0 0; 414 736); layer = &lt;CALayer: 0x170223be0&gt;&gt;</span><br><span class="line">   |    |    |    | &lt;UIView: 0x11de580e0; frame = (-0.666667 -0.666667; 415.333 737.333); alpha = 0; layer = &lt;CALayer: 0x170223ba0&gt;&gt;</span><br><span class="line">   |    |    |    | &lt;_MFActorSnapshotView: 0x11de58280; frame = (0 0; 414 736); opaque = NO; layer = &lt;CALayer: 0x170223ae0&gt;&gt;</span><br><span class="line">   |    |    |    |    | &lt;UIImageView: 0x11de58640; frame = (0 0; 414 736); userInteractionEnabled = NO; layer = &lt;CALayer: 0x170223b00&gt;&gt;</span><br><span class="line">   |    |    |    | &lt;UILayoutContainerView: 0x11dd77030; frame = (0 0; 414 736); clipsToBounds = YES; opaque = NO; autoresize = LM+W+RM+TM+H+BM; gestureRecognizers = &lt;NSArray: 0x17025ae50&gt;; layer = &lt;CALayer: 0x17403d4c0&gt;&gt;</span><br><span class="line">   |    |    |    |    |    | &lt;MailboxTableCell: 0x11e882e00; baseClass = UITableViewCell; frame = (0 28; 414 44); text = &apos;Inbox&apos;; autoresize = W; layer = &lt;CALayer: 0x17422a860&gt;&gt;</span><br><span class="line">   |    |    |    |    |    |    | &lt;UITableViewCellContentView: 0x11dd8fce0; frame = (0 0; 376 43.6667); gestureRecognizers = &lt;NSArray: 0x17425cc20&gt;; layer = &lt;CALayer: 0x17422a8a0&gt;&gt;</span><br><span class="line">   |    |    |    |    |    |    |    | &lt;UITableViewLabel: 0x11dd95d70; frame = (55 12; 305.333 20.3333); text = &apos;Inbox&apos;; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x174283bb0&gt;&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>搜索页面中第一个title<code>Inbox</code>找到相关类<code>MailboxTableCell 0x11e882e00</code> 找到它的响应连。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cy# [#0x11e882e00 nextResponder]</span><br><span class="line">#&quot;&lt;UITableViewWrapperView: 0x11e87c200; frame = (0 0; 414 672); gestureRecognizers = &lt;NSArray: 0x17424fe40&gt;; layer = &lt;CALayer: 0x17403d3a0&gt;; contentOffset: &#123;0, 0&#125;; contentSize: &#123;414, 672&#125;&gt;&quot;</span><br><span class="line">cy# [#0x11e87c200 nextResponder]</span><br><span class="line">#&quot;&lt;UITableView: 0x11e896400; frame = (0 0; 414 736); clipsToBounds = YES; autoresize = W+H; gestureRecognizers = &lt;NSArray: 0x17424fb10&gt;; layer = &lt;CALayer: 0x17403f1a0&gt;; contentOffset: &#123;0, -64&#125;; contentSize: &#123;414, 560&#125;&gt;&quot;</span><br><span class="line">cy# [#0x11e896400 nextResponder]</span><br><span class="line">#&quot;&lt;MailboxPickerController: 0x11dd464a0&gt;&quot;</span><br></pre></td></tr></table></figure>
<p>最终找到控制器<code>MailboxPickerController</code><br>测试修改Title。发现Title改变。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy# [#0x11dd464a0 setTitle:@&quot;vvusu&quot;]</span><br></pre></td></tr></table></figure>
<p>测试修改导航栏左边按钮：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy# #0x125e47660.navigationItem.leftBarButtonItem = #0x125e47660.navigationItem.rightBarButtonItem</span><br><span class="line">#&quot;&lt;UIBarButtonItem: 0x125de57a0&gt;&quot;</span><br></pre></td></tr></table></figure>
<p>确定MailboxPickerController就是<code>Mailboxes</code>界面的controller，可以通过它添加白名单按钮。</p>
<h4 id="用Reveal和Cycript找到All-Inboxes界面的-delegate"><a href="#用Reveal和Cycript找到All-Inboxes界面的-delegate" class="headerlink" title="用Reveal和Cycript找到All Inboxes界面的 delegate"></a>用Reveal和Cycript找到All Inboxes界面的 delegate</h4><p>点击进入Inbox页面，打印控制器列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cy# [[[UIWindow keyWindow] rootViewController] _printHierarchy].toString()</span><br><span class="line">`&lt;MFApplicationSceneController 0x126896a00&gt;, state: appeared, view: &lt;UIView 0x125e575d0&gt;</span><br><span class="line">   | &lt;MailSplitViewController 0x125d77db0&gt;, state: appeared, view: &lt;UILayoutContainerView 0x125e5a820&gt;</span><br><span class="line">   |    | &lt;UIMultiColumnViewController 0x125d77630&gt;, state: appeared, view: &lt;UIView 0x125e68210&gt;</span><br><span class="line">   |    |    | &lt;MailNavigationController 0x12684c800&gt;, state: appeared, view: &lt;UILayoutContainerView 0x125e47f30&gt;</span><br><span class="line">   |    |    |    | &lt;MailboxPickerController 0x125e47660&gt;, state: disappeared, view: &lt;UITableView 0x126872000&gt; not in the window</span><br><span class="line">   |    |    |    | &lt;MailboxContentViewController 0x126048c00&gt;, state: appeared, view: &lt;MFSwipableTableView 0x126855000&gt;</span><br><span class="line">   |    |    | &lt;UINavigationController 0x12606cc00&gt;, state: disappeared, view:  (view not loaded)</span><br><span class="line">   |    | &lt;MailDetailNavigationController 0x126893400&gt;, state: disappeared, view: &lt;UILayoutContainerView 0x125e58be0&gt; not in the window</span><br><span class="line">   |    |    | &lt;MFConversationViewController 0x12681e200&gt;, state: disappeared, view: &lt;UIView 0x125ea9620&gt; not in the window`</span><br></pre></td></tr></table></figure>
<p>找到控制器<code>MailboxContentViewController</code>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cy# [#0x126048c00 setTitle:@&quot;vvusu&quot;]</span><br></pre></td></tr></table></figure>
<p>控制Title已修改，已找到实现代理控制器。</p>
<h4 id="MailboxContentViewController中定位“刷新完成”的响应函数"><a href="#MailboxContentViewController中定位“刷新完成”的响应函数" class="headerlink" title="MailboxContentViewController中定位“刷新完成”的响应函数"></a>MailboxContentViewController中定位“刷新完成”的响应函数</h4><p>看看<code>MailboxContentViewController</code>实现了哪些protocol，其中找到可疑的响应函数，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@interface MailboxContentViewController : UIViewController &lt;MFAddressBookClient, MailboxContentSelectionModelDataSource, MFMailboxFilterPickerViewControllerDelegate, MessageMiniMallObserver, MFReclaimable, MFSearchControllerDelegate, MFSwipableTableViewDelegate, UIPopoverPresentationControllerDelegate, UIViewControllerPreviewingDelegate, UIViewControllerPreviewingDelegate_Private, MFDisclosureSelectionTableViewDelegate, MFConversationViewControllerDelegate, MFMoveToPredictionTriageInteractionDelegate, MFTransferStackControllerDelegate, MFExpandedMessageCollectionStrategyDelegate, UITableViewDelegate, UITableViewDataSource, AutoFetchControllerDataSource, MFKeyCommandReacting&gt;</span><br></pre></td></tr></table></figure>
<p>查找<code>protocol</code>跟“刷新数据源”有关系的方法。</p>
<p>查看相关代理方法可能有关系的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MailboxContentSelectionModelDataSource</span><br><span class="line">MessageMiniMallObserver</span><br><span class="line">MFMailboxTableViewDelegate</span><br><span class="line">TransferMailboxPickerDelegate</span><br><span class="line">AutoFetchControllerDataSource</span><br></pre></td></tr></table></figure>
<h5 id="MailboxContentSelectionModelDataSource-Protocol-h"><a href="#MailboxContentSelectionModelDataSource-Protocol-h" class="headerlink" title="MailboxContentSelectionModelDataSource-Protocol.h"></a>MailboxContentSelectionModelDataSource-Protocol.h</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;NSObject-Protocol.h&quot;</span><br><span class="line"></span><br><span class="line">@class MFMessageInfo, MailboxContentSelectionModel, NSIndexPath, NSSet;</span><br><span class="line">@protocol MiniMallSource;</span><br><span class="line"></span><br><span class="line">@protocol MailboxContentSelectionModelDataSource &lt;NSObject&gt;</span><br><span class="line">- (_Bool)selectionModel:(MailboxContentSelectionModel *)arg1 deleteMovesToTrashForTableIndexPath:(NSIndexPath *)arg2;</span><br><span class="line">- (void)selectionModel:(MailboxContentSelectionModel *)arg1 getConversationStateAtTableIndexPath:(NSIndexPath *)arg2 hasUnread:(_Bool *)arg3 hasUnflagged:(_Bool *)arg4;</span><br><span class="line">- (void)selectionModel:(MailboxContentSelectionModel *)arg1 getSourceStateHasUnread:(_Bool *)arg2 hasUnflagged:(_Bool *)arg3;</span><br><span class="line">- (NSIndexPath *)selectionModel:(MailboxContentSelectionModel *)arg1 indexPathForMessageInfo:(MFMessageInfo *)arg2;</span><br><span class="line">- (NSSet *)selectionModel:(MailboxContentSelectionModel *)arg1 messageInfosAtTableIndexPath:(NSIndexPath *)arg2;</span><br><span class="line">- (NSSet *)selectionModel:(MailboxContentSelectionModel *)arg1 messagesForMessageInfos:(NSSet *)arg2;</span><br><span class="line">- (_Bool)selectionModel:(MailboxContentSelectionModel *)arg1 shouldArchiveByDefaultForTableIndexPath:(NSIndexPath *)arg2;</span><br><span class="line">- (id &lt;MiniMallSource&gt;)selectionModel:(MailboxContentSelectionModel *)arg1 sourceForMessageInfo:(MFMessageInfo *)arg2;</span><br><span class="line">- (_Bool)selectionModel:(MailboxContentSelectionModel *)arg1 supportsArchivingForTableIndexPath:(NSIndexPath *)arg2;</span><br><span class="line">- (NSSet *)sourcesForSelectionModel:(MailboxContentSelectionModel *)arg1;</span><br><span class="line"></span><br><span class="line">@optional</span><br><span class="line">- (NSSet *)selectionModel:(MailboxContentSelectionModel *)arg1 sourcesForMessageInfos:(NSSet *)arg2;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h5 id="MessageMiniMallObserver-Protocol-h"><a href="#MessageMiniMallObserver-Protocol-h" class="headerlink" title="MessageMiniMallObserver-Protocol.h"></a>MessageMiniMallObserver-Protocol.h</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@class NSNotification;</span><br><span class="line">@protocol MessageMiniMallObserver</span><br><span class="line">- (void)miniMallCurrentMessageRemoved:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallDidFinishSearch:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallDidLoadMessages:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallFinishedFetch:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallGrowingMailboxesChanged:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallMessageCountDidChange:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallMessageCountWillChange:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallMessagesAtIndexPathsChanged:(NSNotification *)arg1;</span><br><span class="line">- (void)miniMallStartFetch:(NSNotification *)arg1;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>这个类中函数名含有完成时态动词，同时从“LoadMessages”、“FinishedFetch”、“MessageCountChanged”等函数的名字上来看，它可能会在刷新完成的前后得到调用。<br>接下来用LLDB在这3个函数的开头部分下断点，然后下拉刷新收件箱，看看它们的调用情况。首先用LLDB附加MobileMail，查看其ASLR偏移<code>0x00000000000d0000</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process connect connect://192.168.11.66:1234</span><br><span class="line">Process 11804 stopped</span><br><span class="line">* thread #1: tid = 0xb3da2, 0x00000001882ed188 libsystem_kernel.dylib`mach_msg_trap + 8, queue = &apos;com.apple.main-thread&apos;, stop reason = signal SIGSTOP</span><br><span class="line">    frame #0: 0x00000001882ed188 libsystem_kernel.dylib`mach_msg_trap + 8</span><br><span class="line">libsystem_kernel.dylib`mach_msg_trap:</span><br><span class="line">-&gt;  0x1882ed188 &lt;+8&gt;: ret</span><br><span class="line"></span><br><span class="line">libsystem_kernel.dylib`mach_msg_overwrite_trap:</span><br><span class="line">    0x1882ed18c &lt;+0&gt;: movn   x16, #0x1f</span><br><span class="line">    0x1882ed190 &lt;+4&gt;: svc    #0x80</span><br><span class="line">    0x1882ed194 &lt;+8&gt;: ret</span><br><span class="line">(lldb)image list -o -f</span><br><span class="line">[  0] 0x00000000000d0000 /Applications/MobileMail.app/MobileMail(0x00000001000d0000)</span><br><span class="line">[  1] 0x0000000100430000 /Library/MobileSubstrate/MobileSubstrate.dylib(0x0000000100430000)</span><br><span class="line">[  2] 0x0000000007cc8000 /Users/vvusu/Library/Developer/Xcode/iOS DeviceSupport/10.2 (14C92)/Symbols/System/Library/PrivateFrameworks/UserManagement.framework/UserManagement</span><br><span class="line">[  3] 0x0000000007cc8000 /Users/vvusu/Library/Developer/Xcode/iOS DeviceSupport/10.2 (14C92)/Symbols/System/Library/Frameworks/OpenGLES.framework/OpenGLES</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>把MobileMail拖进IDA,查看<br><code>[MailboxContentViewController megaMallDidLoadMessages:]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                     -[MailboxContentViewController miniMallDidLoadMessages:]:</span><br><span class="line">000000010000a910         stp        x20, x19, [sp, #-0x20]!                     ; Objective C Implementation defined at 0x10029b208 (instance method), DATA XREF=0x10029b208</span><br><span class="line">000000010000a914         stp        x29, x30, [sp, #0x10]</span><br><span class="line">000000010000a918         add        x29, sp, #0x10</span><br><span class="line">000000010000a91c         mov        x19, x0</span><br></pre></td></tr></table></figure>
<p><code>[MailboxContentViewController miniMallFinishedFetch:]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                     -[MailboxContentViewController miniMallFinishedFetch:]:</span><br><span class="line">000000010003c57c         stp        x29, x30, [sp, #-0x10]!                     ; Objective C Implementation defined at 0x10029b1a8 (instance method), DATA XREF=0x10029b1a8</span><br><span class="line">000000010003c580         mov        x29, sp</span><br><span class="line">000000010003c584         sub        sp, sp, #0x30</span><br><span class="line">000000010003c588         adrp       x8, #0x100270000</span><br></pre></td></tr></table></figure>
<p><code>[MailboxContentViewController miniMallMessageCountDidChange:]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                     -[MailboxContentViewController miniMallMessageCountDidChange:]:</span><br><span class="line">000000010003c864         stp        x22, x21, [sp, #-0x30]!                     ; Objective C Implementation defined at 0x10029b238 (instance method), DATA XREF=0x10029b238</span><br><span class="line">000000010003c868         stp        x20, x19, [sp, #0x10]</span><br><span class="line">000000010003c86c         stp        x29, x30, [sp, #0x20]</span><br></pre></td></tr></table></figure>
<p>用LLDB在这些地址上下断点，然后下拉刷新，触发断点如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">(lldb) br s -a &apos;0x00000000000d0000 + 0x000000010000a910&apos;</span><br><span class="line">Breakpoint 1: where = MobileMail`_mh_execute_header + 25960, address = 0x00000001000da910</span><br><span class="line">(lldb) br s -a &apos;0x00000000000d0000 + 0x000000010003c57c&apos;</span><br><span class="line">Breakpoint 2: where = MobileMail`_mh_execute_header + 229844, address = 0x000000010010c57c</span><br><span class="line">(lldb) br s -a &apos;0x00000000000d0000 + 0x000000010003c864&apos;</span><br><span class="line">Breakpoint 3: where = MobileMail`_mh_execute_header + 230588, address = 0x000000010010c864</span><br><span class="line">(lldb) c</span><br><span class="line">Process 11804 resuming</span><br><span class="line">Process 11804 stopped</span><br><span class="line">* thread #1: tid = 0xb3da2, 0x000000010010c864 MobileMail`_mh_execute_header + 247908, queue = &apos;MessageMiniMall.0x1741841d0&apos;, stop reason = breakpoint 3.1</span><br><span class="line">    frame #0: 0x000000010010c864 MobileMail`_mh_execute_header + 247908</span><br><span class="line">MobileMail`_mh_execute_header:</span><br><span class="line">-&gt;  0x10010c864 &lt;+247908&gt;: stp    x22, x21, [sp, #-48]!</span><br><span class="line">    0x10010c868 &lt;+247912&gt;: stp    x20, x19, [sp, #16]</span><br><span class="line">    0x10010c86c &lt;+247916&gt;: stp    x29, x30, [sp, #32]</span><br><span class="line">    0x10010c870 &lt;+247920&gt;: add    x29, sp, #32              ; =32</span><br><span class="line">(lldb) c</span><br><span class="line">Process 11804 resuming</span><br><span class="line">Process 11804 stopped</span><br><span class="line">* thread #34: tid = 0xb45b7, 0x000000010010c57c MobileMail`_mh_execute_header + 247164, stop reason = breakpoint 2.1</span><br><span class="line">    frame #0: 0x000000010010c57c MobileMail`_mh_execute_header + 247164</span><br><span class="line">MobileMail`_mh_execute_header:</span><br><span class="line">-&gt;  0x10010c57c &lt;+247164&gt;: stp    x29, x30, [sp, #-16]!</span><br><span class="line">    0x10010c580 &lt;+247168&gt;: mov    x29, sp</span><br><span class="line">    0x10010c584 &lt;+247172&gt;: sub    sp, sp, #48               ; =48</span><br><span class="line">    0x10010c588 &lt;+247176&gt;: adrp   x8, 564</span><br><span class="line">(lldb)</span><br><span class="line">Process 11804 resuming</span><br></pre></td></tr></table></figure>
<p><code>miniMallFinishedFetch</code>方法和<code>miniMallMessageCountDidChange</code>方法都会调用。<br>接下来的任务是寻找拿到所有邮件的方法。</p>
<h4 id="从MessageMiniMall中拿到所有邮件"><a href="#从MessageMiniMall中拿到所有邮件" class="headerlink" title="从MessageMiniMall中拿到所有邮件"></a>从MessageMiniMall中拿到所有邮件</h4><p>“协议方法被调用，一般是因为方法名中提到的那个事件发生了；而那件事发生的对象，一般是协议方法的参数”吗？删掉前2个断点，保留第3个，也就是<code>miniMallMessageCountDidChange:</code>上的断点，看看它的参数是什么，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po $x19</span><br><span class="line">NSConcreteNotification 0x17425e570 &#123;name = MiniMallMessageCountDidChange; object = &lt;MessageMiniMall: 0x1741841d0&gt;; userInfo = MMRowsChangedContext removed:(none), inserted:(none), updated:&#123;(</span><br><span class="line">    &lt;NSIndexPath: 0xc000000000000016&gt; &#123;length = 2, path = 0 - 0&#125;</span><br><span class="line">)&#125;, relocated:(none), destination:(none), mergedConversations:(none)&#125;</span><br></pre></td></tr></table></figure>
<p>参数是一个<code>NSConcreteNotification</code>对象。查看其头文件，可知它继承自NSNotification。它的name是<code>miniMallMessageCountDidChange</code>,object是一个MessageMiniMall对象.</p>
<p>查看MessageMiniMall.h，看看它的内容，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@class MFActivityMonitor, MFMailMessage, MFMessageInfoOrderedSet, MessageSelectionStrategy, NSCache, NSDictionary, NSMutableSet, NSString, SourceSearchContext;</span><br><span class="line">@protocol OS_dispatch_queue;</span><br><span class="line"></span><br><span class="line">@interface MessageMiniMall : NSObject &lt;MFDiagnosticsGenerator, MessageSelectionDataSource, MiniMallSourceBulkOperationsDelegate&gt;</span><br><span class="line">...</span><br><span class="line">- (id)copyAllMessages;</span><br><span class="line">- (unsigned long long)localMessageCount;</span><br><span class="line">- (void)markAllMessagesAsDeletedOrArchived:(unsigned long long)arg1;</span><br><span class="line">- (void)markAllMessagesAsFlagged;</span><br><span class="line">- (void)markAllMessagesAsNotFlagged;</span><br><span class="line">- (void)markAllMessagesAsNotViewed;</span><br><span class="line">- (void)markAllMessagesAsViewed;</span><br><span class="line">- (void)markMessages:(id)arg1 asDeletedOrArchived:(unsigned long long)arg2;</span><br><span class="line">- (void)markMessagesAsFlagged:(id)arg1;</span><br><span class="line">- (void)markMessagesAsJunk:(id)arg1;</span><br><span class="line">- (void)markMessagesAsNotFlagged:(id)arg1;</span><br><span class="line">- (void)markMessagesAsNotJunk:(id)arg1;</span><br><span class="line">- (void)markMessagesAsNotViewed:(id)arg1;</span><br><span class="line">- (void)markMessagesAsViewed:(id)arg1;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>发现方法“复制所有邮件、当前邮件、读取早期邮件、本地邮件计数、邮件计数、标为已读……“<code>MessageMiniMall</code>应该就是一个管理所有邮件对象的管理者。尝试着通过<code>- (id)copyAllMessages;</code>拿到所有的邮件，在LLDB里试一下，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [0x174192620 copyAllMessages]</span><br><span class="line">&#123;(</span><br><span class="line">    &lt;MFLibraryMessage 0x143de28a0: library id 295, remote id 1333714967, conversation id 524108692882186053, 2017-02-09 01:29:08 +0000, subject hash: &lt;9cdcab9e 2f66ad52 f867dac2 ee7e3cf7 8e94d811&gt;&gt;,</span><br><span class="line">    &lt;MFLibraryMessage 0x143d8a1a0: library id 301, remote id 1333714974, conversation id -5996875561049400297, 2017-02-23 09:52:07 +0000, subject hash: &lt;957a6ec0 0d226e39 27721f65 82c7bdd2 ed321b71&gt;&gt;,</span><br><span class="line">    &lt;MFLibraryMessage 0x143d65730: library id 314, remote id 1333714977, conversation id -5225043346560767357, 2017-02-24 05:56:47 +0000, subject hash:    &lt;MFLibraryMessage 0x143ebbfe0: library id 315, remote id 1333714978, conversation id -856873890138472988, 2017-02-24 06:59:43 +0000, subject hash: &lt;da39a3ee 5e6b4b0d 3255bfef 95601890 afd80709&gt;&gt;,</span><br><span class="line">    &lt;MFLibraryMessage 0x143ddbf30: library id 313, remote id 1333714976, conversation id -5225043346560767357, 2017-02-24 05:50:42 +0000, subject hash: &lt;da39a3ee 5e6b4b0d 3255bfef 95601890 afd80709&gt;&gt;,</span><br><span class="line">    &lt;MFLibraryMessage 0x143e63420: library id 300, remote id 1333714973, conversation id -3478309731197128726, 2017-02-21 04:00:11 +0000, subject hash: &lt;5fcacdee c1b93ceb f297ec10 5ae0d003 fa94e8e5&gt;&gt;</span><br><span class="line">)&#125;</span><br><span class="line">(lldb) p (int)[[$x19 object] localMessageCount]</span><br><span class="line">(int) $4 = 12</span><br><span class="line">(lldb) p (int)[[[$x19 object] copyAllMessages] count]</span><br><span class="line">(int) $5 = 12</span><br><span class="line">(lldb) p (int)[[$x19 object] messageCount]</span><br><span class="line">(int) $6 = 11</span><br><span class="line">(lldb) po [[[$x19 object] copyAllMessages] class]</span><br><span class="line">__NSSetM</span><br></pre></td></tr></table></figure>
<p><code>copyAllMessages</code>返回了一个<code>NSSet</code>，其中含有12个<code>MFLibraryMessage</code>对象，<code>MFLibraryMessage</code>对象中含有邮件摘要信息，且NSSet中对象的个数与<code>localMessageCount</code>的值相同。这个结果很好理解：为了节省带宽流量和本地空间，iOS没有必要一次性下 载邮件服务器上的所有邮件，因此会先存储个百十来封，用户如果要看更多的邮件，再去服务器获取（即 loadOlderMessages）。因此，<code>copyAllMessages</code>就是拿到所有邮件的方法。<br>同时<code>[MessageMiniMall markMessagesAsViewed:]</code>函数，如果不出意外，它就是把邮件标记为已读的方法，而参数则很有可能是一个含有<code>MFLibraryMessage</code>对象的<code>NSArray</code>或<code>NSSet</code>。</p>
<h4 id="从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读"><a href="#从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读" class="headerlink" title="从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读"></a>从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读</h4><p>一封邮件就是一个<code>MFLibraryMessage</code>对象，它的description里显示的正是邮件摘要。在MessageMiniMall的头文件中是找不到它的身影的，想必你也能猜到大致原因<code>MFLibraryMessage</code>来自一个外部dylib。<br>MFLibraryMessage.h的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@interface MFLibraryMessage : MFMailMessage &#123;</span><br><span class="line">    unsigned long long  _conversationFlags;</span><br><span class="line">    unsigned int  _libraryID;</span><br><span class="line">    unsigned int  _mailboxID;</span><br><span class="line">    NSString * _messageID;</span><br><span class="line">    NSMutableDictionary * _metadata;</span><br><span class="line">    NSMutableSet * _metadataChangedKeys;</span><br><span class="line">    MFLock * _metadataLock;</span><br><span class="line">    unsigned int  _originalMailboxID;</span><br><span class="line">    NSString * _remoteID;</span><br><span class="line">    unsigned long long  _size;</span><br><span class="line">    unsigned int  _uid;</span><br><span class="line">    unsigned long long  _uniqueRemoteId;</span><br><span class="line">&#125;</span><br><span class="line">+ (id)messageWithLibraryID:(unsigned int)arg1;</span><br><span class="line">- (id)_attachmentStorageLocation;</span><br><span class="line">- (void)_forceLoadOfMessageSummaryFromProtectedStore;</span><br><span class="line">- (void)_initializeMetadata;</span><br><span class="line">- (void)_updateUID;</span><br><span class="line">- @end</span><br></pre></td></tr></table></figure>
<p><code>MFMessageInfo</code>中含有已读信息，但不含有邮件摘要信息，说明分析仍不够严密。再回过头仔细观察 MFLibraryMessage.h，发现它继承自<code>MFMailMessage</code>，从名字上看<code>MailMessage</code>用来代表 邮件显然比<code>LibraryMessage</code>更贴切。打开<code>MFMailMessage.h</code>，看看它的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@interface MFMessage : NSObject &lt;NSCopying&gt; &#123;</span><br><span class="line">    NSArray * _bcc;</span><br><span class="line">    NSString * _cachedMessageIDHeader;</span><br><span class="line">    unsigned int  _calculatedAttachmentInfo;</span><br><span class="line">    NSArray * _cc;</span><br><span class="line">    NSString * _contentType;</span><br><span class="line">    long long  _conversationID;</span><br><span class="line">    unsigned int  _dateReceivedInterval;</span><br><span class="line">    unsigned int  _dateSentInterval;</span><br><span class="line">    NSString * _externalID;</span><br><span class="line">    unsigned long long  _generationNumber;</span><br><span class="line">    long long  _listIDHash;</span><br><span class="line">    long long  _messageIDHeaderHash;</span><br><span class="line">    NSURL * _messageURL;</span><br><span class="line">    unsigned short  _numberOfAttachments;</span><br><span class="line">    MFMimePart * _parentPart;</span><br><span class="line">    unsigned int  _preferredEncoding;</span><br><span class="line">    NSArray * _sender;</span><br><span class="line">    NSString * _senderAddressComment;</span><br><span class="line">    MFMessageStore * _store;</span><br><span class="line">    NSString * _subject;</span><br><span class="line">    NSString * _summary;</span><br><span class="line">    NSArray * _to;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, retain) MFMimePart *parentPart;</span><br><span class="line">+ (Class)dataMessageStoreToUse;</span><br><span class="line">+ (id)messageWithRFC822Data:(id)arg1;</span><br><span class="line">+ (id)messageWithRFC822Data:(id)arg1 withParentPart:(id)arg2;</span><br><span class="line">+ (void)setMessageClassForStore:(id)arg1;</span><br></pre></td></tr></table></figure>
<p>summary、subject、sender、cc、bcc等邮件常用词汇出现在我们面前，但除了subject， MFMailMessage.h中只出现了setter，而不见getter。还 记得刚才我们的注意力是怎么从MFLibraryMessage.h 转移到MFMailMessage.h上的吗？想必你一定也注意 到了MFMailMessage的父类MFMessage。在查看它的 头文件前，先用LLDB看看[MFMailMessage subject]的 返回，验证一下到目前为止的分析，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] subject]</span><br><span class="line">送您的20000金币已到账，速领兑大奖！</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] firstSender]</span><br><span class="line">&quot;疯狂炸金花&quot; &lt;crazy3@service.netease.com&gt;</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] sendersIfCached]</span><br><span class="line">&lt;__NSSingleObjectArrayI 0x170208ab0&gt;(</span><br><span class="line">&quot;疯狂炸金花&quot; &lt;crazy3@service.netease.com&gt;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] senders]</span><br><span class="line">&lt;__NSSingleObjectArrayI 0x170208ab0&gt;(</span><br><span class="line">&quot;疯狂炸金花&quot; &lt;crazy3@service.netease.com&gt;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] to]</span><br><span class="line">&lt;__NSSingleObjectArrayI 0x170208aa0&gt;(</span><br><span class="line">wedxzl@163.com</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] dateSent]</span><br><span class="line">2017-02-09 01:28:56 +0000</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] subject]</span><br><span class="line">送您的20000金币已到账，速领兑大奖！</span><br><span class="line"></span><br><span class="line">(lldb) po [[[[$x19 object] copyAllMessages] anyObject] messageBody]</span><br><span class="line">&lt;MFMimeBody: 0x1704319a0&gt;</span><br></pre></td></tr></table></figure>
<p>firstSender返回了一个发件人，而sendersIfCached 和senders都返回了一个NSArray，说明默认情况下， 在iOS中一封邮件是有可能存在多个发件人的。尽管多个发件人的情况在现实生活中不常见，但为了避免遗漏，这里仍采用senders函数来提取一封邮件中所有可能的发件人地址。最后的任务就 是把邮件标记为已读。</p>
<p>[MessageMiniMall markMessagesAsViewed:]吗？它是 不是把邮件标为已读的方法呢？在这个方法上下一个 断点，看看在把一封邮件标记为已读时，它会不会得 到调用。先在IDA里定位到<code>[MessageMiniMall markMessagesAsViewed:]</code>，看看它的基地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">                     -[MessageMiniMall markMessagesAsViewed:]:</span><br><span class="line">000000010006e710         stp        x22, x21, [sp, #-0x30]!                     ; Objective C Implementation defined at 0x1002a6d10 (instance method), DATA XREF=0x1002a6d10</span><br><span class="line">000000010006e714         stp        x20, x19, [sp, #0x10]</span><br><span class="line">000000010006e718         stp        x29, x30, [sp, #0x20]</span><br><span class="line">000000010006e71c         add        x29, sp, #0x20</span><br></pre></td></tr></table></figure>
<p>测试下断点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) br s -a &apos;0x00000000000c8000+0x000000010006e710&apos;</span><br><span class="line">Breakpoint 5: where = MobileMail`_mh_execute_header + 435048, address = 0x0000000100136710</span><br><span class="line">(lldb) c</span><br><span class="line">Process 11873 resuming</span><br><span class="line">* thread #1: tid = 0xb5cf8, 0x0000000100136710 MobileMail`_mh_execute_header + 452368, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 5.1</span><br><span class="line">    frame #0: 0x0000000100136710 MobileMail`_mh_execute_header + 452368</span><br><span class="line">MobileMail`_mh_execute_header:</span><br><span class="line">-&gt;  0x100136710 &lt;+452368&gt;: stp    x22, x21, [sp, #-48]!</span><br><span class="line">    0x100136714 &lt;+452372&gt;: stp    x20, x19, [sp, #16]</span><br><span class="line">    0x100136718 &lt;+452376&gt;: stp    x29, x30, [sp, #32]</span><br><span class="line">    0x10013671c &lt;+452380&gt;: add    x29, sp, #32              ; =32</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<p>[MessageMiniMall markMessagesAsViewed:]就是把邮件标为已读的方法，且其参数是一个由 MFLibraryMessage对象组成的NSSet。<br>至此，我们成功地在界面上添加了白名单按钮，捕获到了“刷新完成”事件，拿到了所有邮件，提取了其中的发件人地址，并能将它们标为已读。</p>
<p>1.在界面上寻找添加白名单按钮的地方和方法。<br>2.在protocol里寻找“刷新完成”的响应函数。<br>3.从MessageMiniMall中拿到所有邮件。<br>4.从MFLibraryMessage中提取发件人地址。<br>5.用MessageMiniMall将邮件标记为已读。</p>
<h4 id="编写tweak"><a href="#编写tweak" class="headerlink" title="编写tweak"></a>编写tweak</h4><h5 id="用Theos新建tweak工程“AutoMailMarker”"><a href="#用Theos新建tweak工程“AutoMailMarker”" class="headerlink" title="用Theos新建tweak工程“AutoMailMarker”"></a>用Theos新建tweak工程“AutoMailMarker”</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  AutoMailMarker $THEOS/bin/nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [1.] iphone/activator_event</span><br><span class="line">  [2.] iphone/application_modern</span><br><span class="line">  [3.] iphone/cydget</span><br><span class="line">  [4.] iphone/flipswitch_switch</span><br><span class="line">  [5.] iphone/framework</span><br><span class="line">  [6.] iphone/ios7_notification_center_widget</span><br><span class="line">  [7.] iphone/library</span><br><span class="line">  [8.] iphone/notification_center_widget</span><br><span class="line">  [9.] iphone/preference_bundle_modern</span><br><span class="line">  [10.] iphone/tool</span><br><span class="line">  [11.] iphone/tweak</span><br><span class="line">  [12.] iphone/xpc_service</span><br><span class="line">Choose a Template (required): 11</span><br><span class="line">Project Name (required): AutoMailMarker</span><br><span class="line">Package Name [com.yourcompany.automailmarker]: com.vvusu.automailmarker       [ Author/Maintainer Name [vvusu]:</span><br><span class="line">[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.apple.mobilemail</span><br><span class="line">[iphone/tweak] List of applications to terminate upon installation (space-separated, &apos;-&apos; for none) [SpringBoard]: MobileMail</span><br><span class="line">Instantiating iphone/tweak in automailmarker/...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>
<h5 id="构造AutoMailMarker-h"><a href="#构造AutoMailMarker-h" class="headerlink" title="构造AutoMailMarker.h"></a>构造AutoMailMarker.h</h5><p>构造它的目的仅仅是通过编译，避免出现任何报错信息和警告。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;AutoMailMarker.h&quot;</span><br><span class="line"></span><br><span class="line">@interface MailboxPickerController : UITableViewController</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface NSConcreteNotification : NSNotification</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface MessageMiniMall : NSObject</span><br><span class="line">- (NSSet *)copyAllMessages;</span><br><span class="line">- (void)markMessagesAsViewed:(NSSet *)arg1;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface MFMessageInfo : NSObject</span><br><span class="line">@property (nonatomic) BOOL read;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface MFLibraryMessage : NSObject</span><br><span class="line">- (NSArray *)senders;</span><br><span class="line">- (MFMessageInfo *)copyMessageInfo;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h5 id="编辑Tweak-xm"><a href="#编辑Tweak-xm" class="headerlink" title="编辑Tweak.xm"></a>编辑Tweak.xm</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;AutoMailMarker.h&quot;</span><br><span class="line"></span><br><span class="line">%hook MailboxPickerController</span><br><span class="line">%new</span><br><span class="line">- (void)autoMailMarkerWhitelist &#123;</span><br><span class="line">    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@&quot;Whitelist&quot; message:@&quot;Please input an email address&quot; preferredStyle:UIAlertControllerStyleAlert];</span><br><span class="line"></span><br><span class="line">    UIAlertAction *okAction = [UIAlertAction actionWithTitle:@&quot;OK&quot; style:UIAlertActionStyleDefault handler:^(UIAlertAction * action) &#123;</span><br><span class="line">        UITextField *whitelistField = alertController.textFields.firstObject;</span><br><span class="line">        if ([whitelistField.text length] != 0) &#123;</span><br><span class="line">            [[NSUserDefaults standardUserDefaults] setObject:whitelistField.text forKey:@&quot;email.whitelist&quot;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@&quot;Cancel&quot; style:UIAlertActionStyleCancel handler:nil];</span><br><span class="line">    [alertController addAction:okAction];</span><br><span class="line">    [alertController addAction:cancelAction];</span><br><span class="line"></span><br><span class="line">    [alertController addTextFieldWithConfigurationHandler:^(UITextField *textField) &#123;</span><br><span class="line">        textField.text = [[NSUserDefaults standardUserDefaults] objectForKey:@&quot;email.whitelist&quot;];</span><br><span class="line">        textField.placeholder = textField.text;</span><br><span class="line">    &#125;];</span><br><span class="line">    [self presentViewController:alertController animated:YES completion:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLayoutSubviews &#123;</span><br><span class="line">    %orig;</span><br><span class="line">    self.navigationItem.leftBarButtonItem = [[[UIBarButtonItem alloc] initWithTitle: @&quot;Whitelist&quot; style:UIBarButtonItemStylePlain target:self action:@selector(autoMailMarkerWhitelist)]autorelease];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%hook MailboxContentViewController</span><br><span class="line">- (void)miniMallMessageCountDidChange:(NSConcreteNotification *)arg1 &#123;</span><br><span class="line">    %orig;</span><br><span class="line">    NSMutableSet *targetMessages = [NSMutableSet set];</span><br><span class="line">    NSString *whitelist = [NSString stringWithFormat:@&quot;&lt;%@&gt;&quot;,[[NSUserDefaults standardUserDefaults] objectForKey: @&quot;email.whitelist&quot;]];</span><br><span class="line">    MessageMiniMall *managerMail = [arg1 object];</span><br><span class="line">    NSSet *messages = [managerMail copyAllMessages];</span><br><span class="line">    for (MFLibraryMessage *message in messages) &#123;   </span><br><span class="line">         MFMessageInfo *messageInfo = [message copyMessageInfo];</span><br><span class="line">         for (NSString *sender in [message senders]) &#123;</span><br><span class="line">             if (!messageInfo.read &amp;&amp; [sender rangeOfString:whitelist].location == NSNotFound) &#123;</span><br><span class="line">                    [targetMessages addObject:message];</span><br><span class="line">                    [messageInfo release];</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         [messages release];</span><br><span class="line">         [managerMail markMessagesAsViewed:targetMessages];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
<h5 id="编辑Makefile及control"><a href="#编辑Makefile及control" class="headerlink" title="编辑Makefile及control"></a>编辑Makefile及control</h5><p>Makefile文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">THEOS_DEVICE_IP = 192.168.11.66</span><br><span class="line">ARCHS = armv7 arm64</span><br><span class="line">TARGET = iphone:latest:8.0</span><br><span class="line"></span><br><span class="line">include $(THEOS)/makefiles/common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME = AutoMailMarker</span><br><span class="line">AutoMailMarker_FILES = Tweak.xm</span><br><span class="line">include $(THEOS_MAKE_PATH)/tweak.mk</span><br><span class="line">after-install::</span><br><span class="line">	install.exec &quot;killall -9 MobileMail&quot;</span><br></pre></td></tr></table></figure>
<p>control文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Package: com.vvusu.automailmarker</span><br><span class="line">Name: AutoMailMarker</span><br><span class="line">Depends: mobilesubstrate, firmware (&gt;= 8.0)</span><br><span class="line">Version: 1.0</span><br><span class="line">Architecture: iphoneos-arm</span><br><span class="line">Description: Mark non-whitelist emails as read!</span><br><span class="line">Maintainer: vvusu</span><br><span class="line">Author: vvusu</span><br><span class="line">Section: Tweaks</span><br><span class="line">Homepage: http://blog.vvusu.com</span><br></pre></td></tr></table></figure>
<h4 id="安装与测试"><a href="#安装与测试" class="headerlink" title="安装与测试"></a>安装与测试</h4><p>打开邮件程序，添加白名单，测试给自己发一封邮件，点击Inbox查看效果。</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/wedxz">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#功能描述："><span class="toc-number">1.</span> <span class="toc-text">功能描述：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MailAutoMarker"><span class="toc-number">2.</span> <span class="toc-text">MailAutoMarker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定位Mail的可执行文件并class-dump它"><span class="toc-number">3.</span> <span class="toc-text">定位Mail的可执行文件并class-dump它</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用Cycript找到Mailboxes界面的controller"><span class="toc-number">4.</span> <span class="toc-text">用Cycript找到Mailboxes界面的controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用Reveal和Cycript找到All-Inboxes界面的-delegate"><span class="toc-number">5.</span> <span class="toc-text">用Reveal和Cycript找到All Inboxes界面的 delegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MailboxContentViewController中定位“刷新完成”的响应函数"><span class="toc-number">6.</span> <span class="toc-text">MailboxContentViewController中定位“刷新完成”的响应函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MailboxContentSelectionModelDataSource-Protocol-h"><span class="toc-number">6.1.</span> <span class="toc-text">MailboxContentSelectionModelDataSource-Protocol.h</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MessageMiniMallObserver-Protocol-h"><span class="toc-number">6.2.</span> <span class="toc-text">MessageMiniMallObserver-Protocol.h</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从MessageMiniMall中拿到所有邮件"><span class="toc-number">7.</span> <span class="toc-text">从MessageMiniMall中拿到所有邮件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读"><span class="toc-number">8.</span> <span class="toc-text">从MFLibraryMessage中提取发件人地址，用MessageMiniMall标记已读</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写tweak"><span class="toc-number">9.</span> <span class="toc-text">编写tweak</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#用Theos新建tweak工程“AutoMailMarker”"><span class="toc-number">9.1.</span> <span class="toc-text">用Theos新建tweak工程“AutoMailMarker”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#构造AutoMailMarker-h"><span class="toc-number">9.2.</span> <span class="toc-text">构造AutoMailMarker.h</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编辑Tweak-xm"><span class="toc-number">9.3.</span> <span class="toc-text">编辑Tweak.xm</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编辑Makefile及control"><span class="toc-number">9.4.</span> <span class="toc-text">编辑Makefile及control</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装与测试"><span class="toc-number">10.</span> <span class="toc-text">安装与测试</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&text=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&is_video=false&description=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=iOS 越狱开发实战2—将指定邮件标记为已读&body=Check out this article: http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&title=iOS 越狱开发实战2—将指定邮件标记为已读"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://iiooio.com/blog/iOS 越狱开发实战2_将指定邮件标记为已读/&name=iOS 越狱开发实战2—将指定邮件标记为已读&description=&lt;h4 id=&#34;功能描述：&#34;&gt;&lt;a href=&#34;#功能描述：&#34; class=&#34;headerlink&#34; title=&#34;功能描述：&#34;&gt;&lt;/a&gt;功能描述：&lt;/h4&gt;&lt;p&gt;Apple Mail iOS10.2&lt;br&gt;1.在Mail界面上的某个地方加个按钮，点击后出现可编辑的白名单列表，以便进行添加、删除白名单操作。&lt;br&gt;2.每次Mail的收件箱刷新后,自动把白名单以外的邮件标记为已读。&lt;/p&gt;
&lt;h4 id=&#34;MailAutoMarker&#34;&gt;&lt;a href=&#34;#MailAutoMarker&#34; class=&#34;headerlink&#34; title=&#34;MailAutoMarker&#34;&gt;&lt;/a&gt;MailAutoMarker&lt;/h4&gt;&lt;h4 id=&#34;定位Mail的可执行文件并class-dump它&#34;&gt;&lt;a href=&#34;#定位Mail的可执行文件并class-dump它&#34; class=&#34;headerlink&#34; title=&#34;定位Mail的可执行文件并class-dump它&#34;&gt;&lt;/a&gt;定位Mail的可执行文件并class-dump它&lt;/h4&gt;&lt;figure class=&#34;highlight plain&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;➜  ~ class-dump -S -s -H /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMail.app -o /Users/vvusu/Downloads/Reverse/iOSREDemo/AutoMobileMail/MobileMailHeader&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 iiooio
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/wedxz">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-67266460-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'iiooio';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


